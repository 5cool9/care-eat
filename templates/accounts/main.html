{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Careat</title>

  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  
</head>
<body>
 <!-- top-bar -->
  <div class="title-row">
    <h2 class="title-text">식단 기록</h2>
    <a href="{% url 'accounts:mypage' %}">
      <img class="icon" src="{% static 'images/profile.png' %}" alt="profile" />
    </a>
  </div>
<!-- 날짜 선택 -->
<div class="calendar">
  <div class="date_text" id="month-text"></div>
  <div class="date_select" id="date-select">
  </div>
</div>

<!-- 칼로리 계산 -->
<div class="calory-num">
  <h2 class="calory-focus-num" id="current-kcal">0 </h2> 
  <h2 class="calory-unfocus-num">&nbsp;/ <span id="goal-kcal">1420 </span> kcal</h2> 
</div>
    <!-- 칼로리 바 -->
    <div class="bar">
    <div class="bar-wrapper">
        <div class="bar-fill" style="width: 80%"></div>
    </div>
    </div>
    <!-- 상세 칼로리 -->
    <div class="calorys">
    <div class="calory">
        <div><p>순탄수</p></div>
    <span>0<span style="color:rgba(136, 136, 136, 1)">/180g</span>
    </div>
    <div class="calory">
        <div><p>단백질</p></div>
    <span>0<span style="color:rgba(136, 136, 136, 1)">/75g</span>
    </div>
    <div class="calory">
        <div><p>지방</p></div>
    <span>0<span style="color:#888888">/45g</span>
    </div>
    </div>

 <!-- 식단 추가    -->
<h2 class="title-text" style="margin-top: 50px;">식단 추가</h2>

<div class="meal-list">
    <div class="meal-item">
        <span class="meal-name">아침</span>
        <span class="meal-kcal empty">0Kcal</span>
        <span class="meal-add" data-meal="아침">+</span>
    </div>
</div>
    <div class="meal-item">
      <span class="meal-name">점심</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="점심">+</span>
    </div>
    <div class="meal-item">
      <span class="meal-name">저녁</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="저녁">+</span>
    </div>
    <div class="meal-item">
      <span class="meal-name">간식</span>
      <span class="meal-kcal">0Kcal</span>
      <span class="meal-add" data-meal="간식">+</span>
    </div>
  </div>
  
<!-- 식단 피드백 -->
<div class="feedback">
  <div class="feedback-toggle" onclick="toggleFeedback()">
    <span class="label">식단 피드백</span>
    <img id="feedback-arrow-icon" src="{% static 'images/open.png' %}" alt="open" class="arrow-icon" />
  </div>

    <!-- 식단 판넬 -->
    <div id="feedback-panel" class="feedback-panel">
        <p class="suggest_text1">{{ user.username }}님의 식단 유형은 <span class="highlight">당 과다형</span>이에요.<br>
        당류를 줄이면 빠른 체중감량에 도달할 수 있어요!</p>

        <p class="suggest_text2">간식을 한번에 줄이기 어렵다면 <br> 이런 간식은 어때요?</p>
    
        <div class="suggestions">
        <div class="item">
            <div class="suggest_img">
               <a href="https://lalasweet.kr/product/%EB%9D%BC%EB%9D%BC%EC%8A%A4%EC%9C%97-%EC%A0%80%EB%8B%B9-%EB%AA%A8%EB%82%98%EC%B9%B4-16%EA%B0%9C/29/">
                 <img src="{% static 'images/lalaswit.png' %}" alt="라라스윗">
            </div>
            <div class="item-text">라라스윗 저당 모나카</div></a>
            <div class="item-num">2,500원</div>
            </div>
            <div class="item">
                <div class="suggest_img">
                    <a href="https://mynormal.shop/shop_view/?idx=13&srsltid=AfmBOoq3jk2QJOFGQ4R7DyiYjQhVqsR6JmPiGrmWe9dsYGmdnzuiHyTo">
                        <img src="{% static 'images/mynormal.png' %}" alt="마이노멀">
                </div>
                <div class="item-text">마이노멀 저당 아이스크림 파인트 474ml</div></a>
                <div class="item-num">2,500원</div>
                </div>
                <div class="item">
                    <div class="suggest_img">
                        <a href="https://mynormal.shop/shop_view/?idx=301&srsltid=AfmBOopVXg_PnIVeC-23-l3JJosuGsy7xZ0J8XDhxbL_nXQpsHVszyMk">
                            <img src="{% static 'images/greentea.png' %}" alt="그린티">
                    </div>
                    <div class="item-text">마이노멀 저당 말차 아몬 초코볼 1박스... </div></a>
                    <div class="item-num">11,900원</div>
                    </div>
        </div>
    </div>
</div>

<!-- 운동 추천 -->
<div class="exercise">
    <div class="exercise-toggle" onclick="toggleexercise()">
      <span class="label">운동 추천 </span>
      <img id="exercise-arrow-icon" src="{% static 'images/open.png' %}" alt="open" class="arrow-icon" />
    </div>
    <!-- 운동 추천 판넬 -->
    <div id="exercise-panel" class="exercise-panel">
        <p class="suggest_text1">{{ user.username }}님! 오늘은 간식을 많이 드셨으니 <br> <span class="highlight">유산소 운동</span>어떠신가요?</p>
        <div class="youtube_section">
            <div class="exercise-title">지방타파 고강도 유산소</div>
            <div class="card-slider">
                <div class="card">
                    <a href="https://www.youtube.com/watch?v=5bukb6aeobs"><img src="{% static 'images/youtube1.png' %}" alt="극강의 유산소"/>
                    <div class="card-title">올 것이 왔다... 도전 해보세요 <br> - 20분🔥 땀샤워 고강도 인... </div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="빅씩스"></img>
                        <div class="youtube-title">빅씨스 Bigsis</div>
                    </div>
                </div>
                <div class="card">
                    <a href="https://www.youtube.com/results?search_query=%EB%AC%B4%EC%84%9C%EC%9A%B4+%EC%86%8D%EB%8F%84%EB%A1%9C+%EB%B9%A0%EC%A7%80%EB%8A%94"><img src="{% static 'images/youtube2.png' %}" alt="극강의 유산소"/>
                    <div class="card-title">무서운 속도로 살빠지는 운동<br>🔥이 운동 딱 3주만 해보세요...</div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="빅씩스"></img>
                        <div class="youtube-title">홍둥이</div>
                    </div>
                </div>

                <div class="card">
                    <a href="https://www.youtube.com/watch?v=S4xfkLMJdwI"><img src="{% static 'images/youtube3.png' %}" alt="극강의 유산소"/>
                    <div class="card-title">정말 무서운 속도로 살이 빠지<br>는 극강의 유산소 -41kg 까...</div></a>
                    <div class="youtube">
                        <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="빅씩스"></img>
                        <div class="youtube-title">에이핏 afit</div>
                    </div>
                </div>
            </div>
            </div>

            <div class="youtube_section">
                <div class="exercise-title">NO 층간소음! 가벼운 유산소</div>
                <div class="card-slider">
                    <div class="card">
                        <a href="https://www.youtube.com/watch?v=0IWibGOf1jU"><img src="{% static 'images/youtube4.png' %}" alt="극강의 유산소"/>
                        <div class="card-title">몸 무거운 월요일 - 가볍게 부<br>담없이 28분 층간소음 없는...</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="빅씩스"></img>
                            <div class="youtube-title">빅씨스 Bigsis</div>
                        </div>
                    </div>
                    <div class="card">
                        <a href="https://www.youtube.com/watch?v=s82_Hi_5ItA"><img src="{% static 'images/youtube5.png' %}" alt="극강의 유산소"/>
                        <div class="card-title">살이 이렇게나 빠진다구?! 층<br>간소음❌ 지방 태우기🔥 No...</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="빅씩스"></img>
                            <div class="youtube-title">MIZI</div>
                        </div>
                    </div>
    
                    <div class="card">
                        <img src="{% static 'images/youtube6.png' %}" alt="극강의 유산소"/>
                        <a href="https://www.youtube.com/watch?v=cl5cc1_5zZc"><div class="card-title">층간 소음 걱정 없이 체중 감량<br>보장! 딱 5분 운동!</div></a>
                        <div class="youtube">
                            <img class="youtube-icon" src="{% static 'images/yotube-icon.png' %}" alt="빅씩스"></img>
                            <div class="youtube-title">여리니핏</div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8000/api/diet';
    
    // CSRF 토큰 가져오기
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function getTodayDate() {
      const today = new Date();
      return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    }

    function goToSearch(e) {
      const meal = e.target.dataset.meal;
      const searchUrl = "{% url 'accounts:search' %}";
      console.log("이동할 경로:", `${searchUrl}?meal=${encodeURIComponent(meal)}`);
      location.href = `${searchUrl}?meal=${encodeURIComponent(meal)}`;
    }

    async function fetchDietList(date) {
      try {
        const response = await fetch(`${API_BASE_URL}/?date=${date}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.error("식단 리스트 불러오기 실패:", response.status);
          return [];
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error("API 호출 중 오류 발생:", error);
        return [];
      }
    }

    async function fetchDailyCalories(date) {
      try {
        const response = await fetch(`${API_BASE_URL}/calories/?date=${date}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.error("일일 칼로리 불러오기 실패:", response.status);
          return null;
        }
        
        return await response.json();
      } catch (error) {
        console.error("칼로리 API 호출 중 오류 발생:", error);
        return null;
      }
    }

    const timeSlotMapping = {
      '아침': 'breakfast',
      '점심': 'lunch', 
      '저녁': 'dinner',
      '간식': 'snack'
    };

    const timeSlotReverseMapping = {
      'breakfast': '아침',
      'lunch': '점심',
      'dinner': '저녁', 
      'snack': '간식'
    };

    window.addEventListener("DOMContentLoaded", async () => {
      const today = new Date();
      const monthText = document.getElementById("month-text");
      const dateSelect = document.getElementById("date-select");
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());

      monthText.textContent = `${today.getMonth() + 1}월`;

      for (let i = 0; i < 7; i++) {
        const currentDay = new Date(startOfWeek);
        currentDay.setDate(startOfWeek.getDate() + i);

        const date = currentDay.getDate();
        const isToday = currentDay.toDateString() === today.toDateString();
        const dayText = isToday ? "오늘" : weekdays[i];

        const year = currentDay.getFullYear();
        const month = String(currentDay.getMonth() + 1).padStart(2, '0');
        const day = String(currentDay.getDate()).padStart(2, '0');
        const dateKey = `${year}-${month}-${day}`;

        const dayDiv = document.createElement("div");
        dayDiv.className = "day";

        // localStorage에서 선택된 날짜 확인
        const savedSelectedDate = localStorage.getItem("selectedDate");
        if (savedSelectedDate === dateKey || (!savedSelectedDate && isToday)) {
          dayDiv.classList.add("active");
          if (!savedSelectedDate) localStorage.setItem("selectedDate", dateKey);
        }

        dayDiv.innerHTML = `
          <div>${date}</div>
          <div class="day_text">${dayText}</div>
        `;

        dayDiv.addEventListener("click", () => {
          document.querySelectorAll(".day").forEach(el => el.classList.remove("active"));
          dayDiv.classList.add("active");
          localStorage.setItem("selectedDate", dateKey);
          location.reload(); // 날짜 바뀌면 새로고침해서 데이터 갱신
        });

        dateSelect.appendChild(dayDiv);
      }

      const selectedDate = localStorage.getItem("selectedDate") || getTodayDate();
      
      try {
        const [diets, dailyCalories] = await Promise.all([
          fetchDietList(selectedDate),
          fetchDailyCalories(selectedDate)
        ]);

        const mealTypes = ['아침', '점심', '저녁', '간식'];
        const mealsData = {};
        
        mealTypes.forEach(meal => {
          const englishTimeSlot = timeSlotMapping[meal];
          mealsData[meal] = diets.filter(diet => diet.time_slot === englishTimeSlot);
        });

        let totalKcal = 0;
        mealTypes.forEach(meal => {
          const meals = mealsData[meal] || [];
          const mealKcal = meals.reduce((acc, cur) => {
            return acc + (cur.total_kcal || 0);
          }, 0);

          const kcalSpan = [...document.querySelectorAll('.meal-item')].find(
            item => item.querySelector('.meal-name')?.textContent === meal
          )?.querySelector('.meal-kcal');

          if (kcalSpan) {
            kcalSpan.textContent = `${Math.round(mealKcal)}Kcal`;
            kcalSpan.classList.toggle('empty', mealKcal === 0);
          }

          totalKcal += mealKcal;
        });

        const totalKcalElement = document.querySelector('.calory-focus-num');
        const safeDisplayKcal = dailyCalories && !isNaN(Number(dailyCalories.total_kcal)) 
          ? Number(dailyCalories.total_kcal) 
          : totalKcal;

        if (totalKcalElement) {
          totalKcalElement.textContent = Math.round(safeDisplayKcal);
        }

        const safeTargetKcal = dailyCalories && !isNaN(Number(dailyCalories.target_kcal))
          ? Number(dailyCalories.target_kcal)
          : 1420;

        let percent = Math.min((safeDisplayKcal / safeTargetKcal) * 100, 100);
        if (isNaN(percent)) {
          percent = 0;
        }

        const barFill = document.querySelector('.bar-fill');
        if (barFill) {
          barFill.style.width = `${percent}%`;
        }

        const currentEl = document.getElementById("current-kcal");
        const goalEl = document.getElementById("goal-kcal");
        if (currentEl && goalEl) {
          currentEl.textContent = Math.round(safeDisplayKcal);
          goalEl.textContent = safeTargetKcal;
          
          const barPercent = Math.min((safeDisplayKcal / safeTargetKcal) * 100, 100);
          const caloryBar = document.getElementById("calory-bar");
          if (caloryBar) {
            caloryBar.style.width = `${barPercent}%`;
          }
        }

        document.querySelectorAll('.meal-add').forEach(btn => {
          btn.addEventListener('click', () => {
            const meal = btn.getAttribute('data-meal');
            const existingMeals = mealsData[meal] || [];

            localStorage.setItem('selectedMeal', meal);

            if (existingMeals.length > 0) {
              window.location.href = '/accounts/meal-edit/';
            } else {
              window.location.href = `/accounts/search/?meal=${encodeURIComponent(meal)}`;
            }
          });
        });

      } catch (error) {
        console.error("식단 데이터 로딩 중 오류:", error);
        document.querySelector('.calory-focus-num').textContent = '0';
        document.querySelectorAll('.meal-kcal').forEach(el => {
          el.textContent = '0Kcal';
          el.classList.add('empty');
        });
      }

    });

    function toggleFeedback() {
      const panel = document.getElementById("feedback-panel");
      const arrow = document.getElementById("feedback-arrow-icon");
      const isOpen = panel.style.display === "block";
      panel.style.display = isOpen ? "none" : "block";
      arrow.src = isOpen ? "{% static 'images/open.png' %}" : "{% static 'images/close.png' %}";
      arrow.alt = isOpen ? "열기 아이콘" : "닫기 아이콘";
    }

    function toggleexercise() {
      const panel = document.getElementById("exercise-panel");
      const arrow = document.getElementById("exercise-arrow-icon");
      const isOpen = panel.style.display === "block";
      panel.style.display = isOpen ? "none" : "block";
      arrow.src = isOpen ? "{% static 'images/open.png' %}" : "{% static 'images/close.png' %}";
      arrow.alt = isOpen ? "열기 아이콘" : "닫기 아이콘";

      panel.style.animation = 'none';
      panel.offsetHeight; 
      panel.style.animation = '';
    }
</script>


</body>
</html>